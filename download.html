<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ç¤¾æœƒå±€ - åª’é«”ä¸‹è¼‰æ¨¡çµ„</title>
  <style>
    /* æ ¸å¿ƒé˜²ç ´åœ–å±¬æ€§ */
    * { box-sizing: border-box; }

    body { margin: 0; background: #000; color: #0f0; font-family: 'Courier New', monospace; overflow-x: hidden; overflow-y: auto; }
    canvas { position: fixed; top: 0; left: 0; z-index: -1; opacity: 0.35; }

    /* é›»è…¦ç‰ˆï¼šç¶­æŒåŸæœ¬å®Œç¾çš„è¨­å®š */
    .wrap { position:absolute; inset:0; display:grid; place-items:center; padding: 24px; min-height: 100vh; }
    .panel { width: 100%; max-width: 820px; border: 1px solid rgba(0,255,0,0.45); background: rgba(0, 12, 0, 0.55); box-shadow: 0 0 26px rgba(0,255,0,0.14); padding: 18px 18px 16px; backdrop-filter: blur(6px); }

    .topbar { display:flex; align-items:center; justify-content:space-between; gap: 12px; margin-bottom: 15px; }
    .title { font-size: 1.1rem; letter-spacing: 4px; color: #e8ffe8; text-shadow: 0 0 12px rgba(0,255,0,0.35); white-space: nowrap; }
    .badge { font-size: .85rem; padding: 6px 10px; border: 1px solid rgba(0,255,0,0.35); color: rgba(0,255,0,0.85); background: rgba(0,0,0,0.35); white-space: nowrap; }

    .control-group { display: flex; flex-direction: column; gap: 10px; }
    .row-url { display: flex; width: 100%; }
    .row-settings { display: flex; gap: 10px; flex-wrap: wrap; }
    
    input, select { padding: 12px; background: rgba(0,0,0,0.6); color: #0f0; border: 1px solid rgba(0,255,0,0.42); outline: none; font-size: 1rem; font-family: 'Courier New', monospace; }
    input { flex: 1; min-width: 0; }
    select { flex: 1; min-width: 140px; }

    .btn { padding: 12px 14px; border: 1px solid #0f0; background: transparent; color: #0f0; cursor: pointer; font-size: 1rem; transition: .2s; white-space: nowrap; flex: 0 0 auto; }
    .btn:hover { background: rgba(0,255,0,0.16); box-shadow: 0 0 18px rgba(0,255,0,0.45); }
    .btn:disabled { border-color: #444; color: #444; cursor: not-allowed; }
    .btn-submit { flex: 0 0 140px; font-weight: bold; background: rgba(0, 50, 0, 0.5); border-color: #0f0; }

    /* é›»è…¦ç‰ˆè¼”åŠ©æŒ‰éˆ• */
    .subgrid { display:flex; gap:10px; margin-top: 12px; flex-wrap: wrap; }
    .btn.secondary { border-color: rgba(0,255,0,0.55); color: rgba(0,255,0,0.85); opacity: .9; padding: 10px 14px; }
    .btn.secondary:hover { opacity: 1; }

    .hint { margin-top: 12px; font-size: .92rem; color: rgba(0,255,0,0.72); line-height: 1.5; }
    .result { margin-top: 12px; padding: 12px; border: 1px dashed rgba(0,255,0,0.35); background: rgba(0,0,0,0.38); color: #fff; line-height: 1.6; min-height: 54px; word-break: break-all; }
    .result a { color:#00BFFF; text-decoration:none; font-weight: bold; }
    .result a:hover { text-decoration:underline; }

    .footer { margin-top: 10px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; font-size: .88rem; color: rgba(0,255,0,0.6); }
    .linklike { cursor:pointer; }
    .linklike:hover { text-decoration: underline; }

    /* ğŸ“± æ‰‹æ©Ÿç‰ˆå°ˆå±¬çµç•Œ */
    @media (max-width: 760px){
      .wrap { padding: 16px; align-items: flex-start; padding-top: 5vh; }
      .topbar { flex-direction: column; align-items: center; justify-content: center; gap: 10px; }
      .title { font-size: 1rem; letter-spacing: 2px; }
      .row-settings { flex-direction: column; }
      .btn-submit { width: 100%; flex: 1; }
      .subgrid { flex-direction: column; }
      .btn.secondary { width: 100%; text-align: center; }
    }
  </style>
</head>
<body>
  <canvas id="matrix"></canvas>

  <div class="wrap">
    <div class="panel">
      <div class="topbar">
        <div class="title">ã€ åª’ é«” ä¸‹ è¼‰ æ¨¡ çµ„ ã€‘</div>
        <div class="badge">SECURE CHANNEL</div>
      </div>

      <div class="control-group">
        <div class="row-url">
          <input id="url" placeholder="è²¼ä¸Š YouTube ç¶²å€ æˆ– åª’é«”é€£çµ" />
        </div>
        <div class="row-settings">
          <select id="type" onchange="toggleOptions()">
            <option value="video">ğŸï¸ æ ¼å¼ï¼šå½±ç‰‡ MP4</option>
            <option value="audio">ğŸµ æ ¼å¼ï¼šéŸ³æª” MP3</option>
          </select>
          
          <select id="res_select">
            <option value="best">æœ€é«˜ç•«è³ª (æ”¯æ´ 4K/8K)</option>
            <option value="1080">é™åˆ¶ 1080p (FHD)</option>
            <option value="720">é™åˆ¶ 720p (HD)</option>
            <option value="480">é™åˆ¶ 480p (SD)</option>
          </select>

          <select id="audio_select" style="display:none;">
            <option value="320">ç„¡æç´š 320 kbps</option>
            <option value="192" selected>é«˜éŸ³è³ª 192 kbps</option>
            <option value="128">æ¨™æº–éŸ³è³ª 128 kbps</option>
          </select>

          <button class="btn btn-submit" id="mainBtn" onclick="go()">é–‹å§‹è™•ç†</button>
        </div>
      </div>

      <div class="subgrid">
        <button class="btn secondary" onclick="fillExample('direct')">å¡«å…¥ç¯„ä¾‹ï¼šéŸ³è¨Š</button>
        <button class="btn secondary" onclick="fillExample('other')">å¡«å…¥ç¯„ä¾‹ï¼šå½±ç‰‡</button>
        <button class="btn secondary" onclick="history.back()">â† è¿”å›ä¸Šä¸€é </button>
      </div>

      <div class="hint">
        âœ” <b>å«è™Ÿç³»çµ±å·²å‡ç´š</b>ï¼šå³æ™‚ç›£æ§ä¸‹è¼‰é€²åº¦ï¼Œåˆä½µ 4K è³‡æºæ™‚è«‹ä¿æŒè€å¿ƒã€‚<br/>
        âœ” è™•ç†å®Œæˆå¾Œï¼Œç³»çµ±å°‡è‡ªå‹•è§¸ç™¼ä¸‹è¼‰ã€‚
      </div>

      <div class="result" id="result">ç‹€æ…‹ï¼šç­‰å¾…æŒ‡ä»¤è¼¸å…¥â€¦</div>

      <div class="footer">
        <div>TIPï¼šæ”¯æ´å‹•æ…‹ç•«è³ª/éŸ³è³ªèƒŒæ™¯åˆä½µæŠ€è¡“</div>
        <div class="linklike" onclick="copyLink()">è¤‡è£½æœ¬é é€£çµ</div>
      </div>
    </div>
  </div>

  <script>
    /* --- çŸ©é™£èƒŒæ™¯å‹•ç•« --- */
    const canvas = document.getElementById("matrix");
    const ctx = canvas.getContext("2d");
    function resize(){ canvas.width = innerWidth; canvas.height = innerHeight; }
    resize(); addEventListener("resize", resize);

    const letters = "01010101COMPUTER-IDENTIFIED-ACCESS-DENIED-WELCOME-BACK".split("");
    const fontSize = 16;
    function initDrops(){
      const cols = canvas.width / fontSize;
      return Array(Math.floor(cols)).fill(1);
    }
    let drops = initDrops();
    addEventListener("resize", () => drops = initDrops());

    setInterval(() => {
      ctx.fillStyle = "rgba(0, 0, 0, 0.06)";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#0f0";
      ctx.font = fontSize + "px monospace";
      drops.forEach((y, i) => {
        const t = letters[Math.floor(Math.random() * letters.length)];
        ctx.fillText(t, i * fontSize, y * fontSize);
        if (y * fontSize > canvas.height && Math.random() > 0.975) drops[i] = 0;
        drops[i]++;
      });
    }, 50);

    /* --- åŠŸèƒ½é‚è¼¯ --- */
    const NAS_HOST = "dl.lixiang-cloud.com";

    function toggleOptions() {
      const type = document.getElementById("type").value;
      document.getElementById("res_select").style.display = (type === "video") ? "inline-block" : "none";
      document.getElementById("audio_select").style.display = (type === "audio") ? "inline-block" : "none";
    }

    function setResult(html){ document.getElementById("result").innerHTML = html; }

    function go(){
      const url = document.getElementById("url").value.trim();
      const type = document.getElementById("type").value;
      const resolution = document.getElementById("res_select").value;
      const audio_quality = document.getElementById("audio_select").value;
      const btn = document.getElementById("mainBtn");

      if(!url){ setResult("âš ï¸ ç‹€æ…‹ï¼šè«‹æä¾›æœ‰æ•ˆç¶²å€"); return; }

      const direct = /\.(mp3|mp4|m4a|wav|flac)(\?.*)?$/i.test(url);
      if(direct){
        setResult(`âœ… ç‹€æ…‹ï¼šç›´é€£æª”æ¡ˆåµæ¸¬æˆåŠŸ<br/>â¡ï¸ <a href="${url}" target="_blank" rel="noopener">ğŸ“¥ é»æˆ‘ä¸‹è¼‰ / é–‹å•Ÿ</a>`);
        return;
      }

      btn.disabled = true;
      setResult("â³ ç‹€æ…‹ï¼šæ­£åœ¨è¯ç¹«ä¼ºæœå™¨é ˜å–ä»»å‹™ç·¨è™Ÿ...");

      fetch(`https://${NAS_HOST}/api/download`, {
        method: "POST",
        headers: { 
            "Content-Type": "application/json",
            "ngrok-skip-browser-warning": "true" 
        },
        body: JSON.stringify({ url, type, resolution, audio_quality })
      })
      .then(r => r.json())
      .then(data => {
        if(!data.ok) throw new Error(data.error || "ä»»å‹™å•Ÿå‹•å¤±æ•—");
        setResult(`ğŸ“¡ ç‹€æ…‹ï¼šå·²é ˜å–ä»»å‹™ [${data.task_id.substring(0,8)}...]<br/>æ­£åœ¨åˆå§‹åŒ–åŒæ­¥ç¨‹åº...`);
        pollStatus(data.task_id);
      })
      .catch(err => {
        btn.disabled = false;
        setResult(`âŒ ç‹€æ…‹ï¼šè«‹æ±‚å¤±æ•—<br/>åŸå› ï¼š${err.message}`);
      });
    }

    /* â­ æ ¸å¿ƒï¼šé€²åº¦æ¢è¼ªè©¢é‚è¼¯ â­ */
    function pollStatus(taskId) {
      const btn = document.getElementById("mainBtn");
      
      const interval = setInterval(() => {
        fetch(`https://${NAS_HOST}/api/status/${taskId}`, {
            headers: { "ngrok-skip-browser-warning": "true" }
        })
        .then(r => r.json())
        .then(task => {
          if (task.status === 'completed') {
            clearInterval(interval);
            btn.disabled = false;
            const fullUrl = `https://${NAS_HOST}${task.download_url}`;
            setResult(`âœ… ç‹€æ…‹ï¼šè™•ç†å®Œæˆï¼<br/>â¡ï¸ <a href="${fullUrl}" target="_blank" rel="noopener">ğŸ“¥ é»æˆ‘ä¸‹è¼‰è‡³æœ¬æ©Ÿ</a>`);
            window.location.href = fullUrl;
          } else if (task.status === 'failed') {
            clearInterval(interval);
            btn.disabled = false;
            setResult(`âŒ ç‹€æ…‹ï¼šä¸‹è¼‰å¤±æ•—<br/>åŸå› ï¼š${task.error}`);
          } else if (task.status === 'processing' || task.status === 'merging') {
            
            // ç¹ªè£½ ASCII é€²åº¦æ¢
            const p = parseFloat(task.progress) || 0;
            const barLength = 20;
            const filled = Math.round(barLength * (p / 100));
            const bar = "â–ˆ".repeat(filled) + "â–‘".repeat(barLength - filled);
            
            let msg = `ğŸ“¡ ç‹€æ…‹ï¼šå¾Œç«¯è³‡æ–™åŒæ­¥ä¸­...<br/>`;
            msg += `<span style="color:#0f0; font-family:monospace; letter-spacing:1px;">DOWNLOADS [${bar}] ${p}%</span><br/>`;
            
            if(task.status === 'merging') {
                msg += `âš¡ ç‹€æ…‹ï¼šä¸‹è¼‰å®Œæˆï¼Œæ­£åœ¨é€²è¡Œæ¥µé€Ÿåˆä½µèˆ‡å°è£ (è«‹ç¨å€™)...`;
            } else {
                msg += `ğŸš€ é€Ÿåº¦ï¼š${task.speed || '---'} | é è¨ˆå‰©é¤˜ï¼š${task.eta || '---'}`;
            }
            setResult(msg);
          }
        })
        .catch(e => console.log("é€šè¨Šä¸­..."));
      }, 2000); // æ¯ 2 ç§’è©¢å•ä¸€æ¬¡ï¼Œä¿æŒç©©å®š
    }

    function fillExample(kind){
      document.getElementById("url").value = "https://www.youtube.com/watch?v=WCtJ_EZQQBM";
      document.getElementById("type").value = (kind === "direct") ? "audio" : "video";
      toggleOptions();
      setResult("ç‹€æ…‹ï¼šå·²å¡«å…¥ NewJeans 4K ç¤ºä¾‹ï¼ŒæŒ‰ã€é–‹å§‹è™•ç†ã€å•Ÿå‹•é€²åº¦ç›£æ§ã€‚");
    }

    async function copyLink(){
      try{
        await navigator.clipboard.writeText(location.href);
        setResult("âœ… ç‹€æ…‹ï¼šå·²è¤‡è£½æœ¬é é€£çµåˆ°å‰ªè²¼ç°¿");
      }catch(e){
        setResult("âš ï¸ ç‹€æ…‹ï¼šç€è¦½å™¨ä¸å…è¨±è¤‡è£½");
      }
    }
  </script>
</body>
</html>

